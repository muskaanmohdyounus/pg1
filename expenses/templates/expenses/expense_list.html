{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ”¥ Expense Tracker Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="stylesheet" href="{% static 'expenses/css/expense_list.css' %}">
</head>

<body>

<div class="sidebar">
    <div class="logo-wrapper">
        <div class="logo-container">
            <img src="{% static 'expenses/images/logo.jpeg' %}" alt="Logo">
            <h2>Expense Tracker</h2>
        </div>
    </div>

    <a href="{% url 'expense_list' %}"><i class="fas fa-table"></i> Dashboard</a>
    <a href="{% url 'add_expense' %}"><i class="fas fa-plus-circle"></i> Add Expense</a>
    <a href="{% url 'reports' %}"><i class="fas fa-chart-pie"></i> Reports</a>
    <a href="{% url 'settings' %}"><i class="fas fa-cog"></i> Settings</a>

    {% if user.is_authenticated %}
    <div class="logout-container">
      <form method="POST" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" class="logout">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </form>
    </div>
    {% endif %}
</div>


<div class="main">
    <div class="header">
      <h1>Welcome, <span>{{ user.username }}</span> ðŸ‘‹</h1>
    </div>

    <div class="stats">
      <div class="card">
        <h2>Total Expense</h2>
        <p>â‚¹{{ total }}</p>
      </div>
      <div class="card">
        <h2>Categories</h2>
        <p>{{ category_totals_json|length }}</p>
      </div>
    </div>

    <form method="GET" action="{% url 'expense_list' %}" class="filter-box">
      <input type="text" name="q" list="categories" placeholder="ðŸ” Search category..." value="{{ query|default:'' }}">
      <datalist id="categories">
        <option value="Rent">
        <option value="Electricity">
        <option value="Groceries">
        <option value="Maintenance">
        <option value="Salary">
        <option value="Miscellaneous">
      </datalist>
      <label>From:</label>
      <input type="date" name="start_date" value="{{ start_date|default:'' }}">
      <label>To:</label>
      <input type="date" name="end_date" value="{{ end_date|default:'' }}">
      <button type="submit">Apply</button>
      {% if query or start_date or end_date %}
        <a href="{% url 'expense_list' %}">Clear</a>
      {% endif %}
    </form>

    <table>
      <tr>
        <th>Title</th>
        <th>Amount</th>
        <th>Category</th>
        <th>Date</th>
        <th>Description</th>
        <th>Bill</th>
        <th>Action</th>
      </tr>

      {% for expense in expenses %}
      <tr>
        <td>{{ expense.title }}</td>
        <td>â‚¹{{ expense.amount }}</td>
        <td>{{ expense.category }}</td>
        <td>{{ expense.date }}</td>

        <!-- âœ… Read More Feature -->
        <td class="desc-cell">
            <span class="short-text">{{ expense.description|truncatechars:15 }}</span>
            <span class="full-text" style="display:none;">{{ expense.description }}</span>

            {% if expense.description|length > 50 %}
            <button class="read-more-btn">Read more</button>
            {% endif %}
        </td>

        <td>
          {% if expense.bill_image %}
            <a href="{{ expense.bill_image.url }}" target="_blank">ðŸ“Ž View</a>
          {% else %}
            <span style="color:#9ca3af;">No file</span>
          {% endif %}
        </td>

        <td>
          <a class="edit" href="{% url 'edit_expense' expense.id %}">Edit</a>
          <a class="delete" href="{% url 'delete_expense' expense.id %}">Delete</a>
        </td>
      </tr>

      {% empty %}
      <tr><td colspan="7" style="text-align:center;">No expenses found.</td></tr>
      {% endfor %}
    </table>

    <div class="chart-container">
      <h2>Expenses by Category</h2>
      <canvas id="categoryChart"></canvas>
      {{ category_totals_json|json_script:"category-data" }}
    </div>
</div>


<script>
const categoryData = JSON.parse(document.getElementById('category-data').textContent);
const labels = categoryData.map(item => item.category);
const data = categoryData.map(item => item.total_amount);
const ctx = document.getElementById('categoryChart').getContext('2d');
const colors = ['#f87171','#ef4444','#b91c1c','#fecaca','#fb7185','#fca5a5'];

new Chart(ctx, {
  type: 'doughnut',
  data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
  options: { responsive: true, plugins: { legend: { position: 'right' } } }
});
</script>


<!-- âœ… Read More Toggle Script -->
<script>
document.querySelectorAll(".read-more-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const cell = btn.parentElement;
        const shortText = cell.querySelector(".short-text");
        const fullText = cell.querySelector(".full-text");

        if (fullText.style.display === "none") {
            fullText.style.display = "inline";
            shortText.style.display = "none";
            btn.textContent = "Read less";
        } else {
            fullText.style.display = "none";
            shortText.style.display = "inline";
            btn.textContent = "Read more";
        }
    });
});
</script>

</body>
</html>
