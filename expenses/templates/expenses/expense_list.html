{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ”¥ Expense Tracker Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Fonts + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'expenses/css/expense_list.css' %}?v=17">
  <link rel="stylesheet" href="{% static 'expenses/css/sidebar.css' %}">
</head>
<body>

<!-- Include universal sidebar -->
{% include 'expenses/sidebar.html' %}
 
<div class="main">
    <div class="header">
      <h1>Welcome, <span>{{ user.username }}</span> ðŸ‘‹</h1>
      <a href="{% url 'add_expense' %}" class="btn btn-primary add-expense-btn">
        <i class="fas fa-plus-circle"></i> Add Expense
      </a>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="card">
            <h4>Total Expense</h4>
            <p>â‚¹{{ total }}</p>
        </div>
        {% for key, value in category_summary.items %}
        <div class="card">
            <h4>{{ key }} Expense</h4>
            <p>â‚¹{{ value }}</p>
        </div>
        {% endfor %}
        <div class="card">
            <h4>Highest Expense</h4>
            <p>
              {% if highest_expense %}
                â‚¹{{ highest_expense.amount }}
              {% else %}
                â‚¹0
              {% endif %}
            </p>
        </div>
    </div>

    <!-- Filter Button -->
    <button id="openFilter" class="btn btn-outline-danger mb-3">
        <i class="fas fa-filter"></i> Filter
    </button>

    <!-- Filter Sidebar -->
    <div class="filter-sidebar" id="filterSidebar">
        <div class="filter-header">
            <h4>Filter Expenses</h4>
            <button id="closeFilter" class="btn btn-sm btn-danger">X</button>
        </div>
        
        <div class="filter-body">
            <form method="GET" action="{% url 'expense_list' %}">
                <!-- Title / Description -->
                <div class="mb-3">
                    <label class="form-label">Title / Description</label>
                    <input type="text" id="title" name="title" class="form-control" placeholder="Search title/description">
                </div>

                <!-- Category -->
                <div class="mb-3">
                    <label class="form-label">Category</label>
                    <select id="category" name="category" class="form-select">
                        <option value="">All</option>
                        {% for cat in category_summary.keys %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Property -->
                <div class="mb-3">
                    <label class="form-label">Property</label>
                    <select id="property" name="property" class="form-select">
                        <option value="">-- Select Property --</option>
                        {% for prop in properties %}
                        <option value="{{ prop.id }}">{{ prop.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Amount Range -->
                <div class="mb-3">
                    <label class="form-label">Amount Range</label>
                    <div class="d-flex gap-2">
                        <input type="number" id="minAmount" name="minAmount" class="form-control" placeholder="Min">
                        <input type="number" id="maxAmount" name="maxAmount" class="form-control" placeholder="Max">
                    </div>
                </div>

                <!-- Date Range -->
                <div class="mb-3">
                    <label class="form-label">Start Date</label>
                    <input type="date" id="startDate" name="startDate" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">End Date</label>
                    <input type="date" id="endDate" name="endDate" class="form-control">
                </div>

                <!-- Quick Date Buttons -->
                <div class="mb-3 d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-outline-secondary quick-date" data-range="7">Last 7 Days</button>
                    <button type="button" class="btn btn-outline-secondary quick-date" data-range="30">Last 30 Days</button>
                    <button type="button" class="btn btn-outline-secondary quick-date" data-range="90">Last 90 Days</button>
                </div>

                <!-- Has Bill -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="hasBill" name="hasBill">
                    <label class="form-check-label" for="hasBill">Has Bill</label>
                </div>

                <!-- Buttons -->
                <div class="d-flex gap-2">
                    <button type="button" id="resetFilters" class="btn btn-secondary w-50">Reset</button>
                    <button type="submit" id="applyFilters" class="btn btn-danger w-50">Apply</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chart -->
    <div class="chart-container mt-4">
        <h2>Expenses by Category</h2>
        <canvas id="categoryChart"></canvas>
    </div>

    <!-- Expense Table -->
    <div class="expense-table-wrapper mt-4">
      <table class="expense-table table table-striped table-hover">
        <thead>
          <tr>
            <th>Category</th>
            <th>Subcategory</th>
            <th>Property</th>
            <th>Amount</th>
            <th>Entry Date</th>
            <th>Created At</th>
            <th>Description</th>
            <th>Paid By</th>
            <th>Paid To</th>
            <th>Paid Mode</th>
            <th>Bill</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for expense in expenses %}
          <tr class="clickable-row" data-url="{% url 'expense_detail' expense.id %}">
              <td>{% if expense.category %}{{ expense.category.name }}{% else %}No Category{% endif %}</td>
              <td>{{ expense.sub_category|default:"No Subcategory" }}</td>
              <td>{% if expense.property %}{{ expense.property.name }}{% else %}No Property{% endif %}</td>
              <td>â‚¹{{ expense.amount }}</td>
              <td>{{ expense.entry_date|date:"Y-m-d" }}</td>
              <td>{{ expense.created_at|date:"Y-m-d H:i" }}</td>
              <td>{{ expense.description|truncatechars:50 }}</td>
              <td>{{ expense.paid_by|default:"N/A" }}</td>
              <td>{{ expense.paid_to|default:"N/A" }}</td>
              <td>{{ expense.paid_mode|default:"N/A" }}</td>
              <td>{% if expense.bill_image %}<a href="{{ expense.bill_image.url }}" target="_blank">ðŸ“Ž View</a>{% else %}No Bill{% endif %}</td>
              <td>
                  <a href="{% url 'edit_expense' expense.id %}" class="edit">Edit</a>
                  <a href="{% url 'delete_expense' expense.id %}" class="delete">Delete</a>
              </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="12" class="text-center">No expenses found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pass chart data safely to JS -->
    {{ chart_labels|json_script:"chart-labels" }}
    {{ chart_values|json_script:"chart-values" }}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'expenses/js/expense_list.js' %}?v=13"></script>
</div>
</body>
</html>
